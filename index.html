        // Save to localStorage
        localStorage.setItem('skincastUser', JSON.stringify(user));
        localStorage.setItem(`skincastUser_${user.id}`, JSON.stringify(user));
        
        currentUser = user;
        closeAuth();
        showUserMenu();
        showNotification('Account created successfully!', 'success');
    }

    function handleLogin(event) {
        event.preventDefault();
        
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        
        // Find user in localStorage
        const users = Object.keys(localStorage)
            .filter(key => key.startsWith('skincastUser_'))
            .map(key => JSON.parse(localStorage.getItem(key)));
        
        const user = users.find(u => u.email === email && u.password === password);
        
        if (user) {
            currentUser = user;
            localStorage.setItem('skincastUser', JSON.stringify(user));
            closeAuth();
            showUserMenu();
            loadUserData();
            showNotification('Logged in successfully!', 'success');
        } else {
            showNotification('Invalid email or password', 'error');
        }
    }

    function logout() {
        currentUser = null;
        localStorage.removeItem('skincastUser');
        document.getElementById('auth-buttons').classList.remove('hidden');
        document.getElementById('user-menu').classList.add('hidden');
        showNotification('Logged out successfully', 'info');
        location.reload();
    }

    function showUserMenu() {
        document.getElementById('auth-buttons').classList.add('hidden');
        document.getElementById('user-menu').classList.remove('hidden');
        document.getElementById('user-name').textContent = currentUser.name.split(' ')[0];
    }

    function viewDashboard() {
        // Scroll to results or show user dashboard
        if (document.getElementById('results-section').classList.contains('hidden')) {
            showNotification('Please complete an analysis first', 'warning');
        } else {
            document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });
        }
    }

    function loadUserData() {
        if (!currentUser || !currentSkinType) return;
        
        // Load user's saved data
        const analyses = currentUser.analyses || [];
        const savedProducts = currentUser.savedProducts || [];
        
        // Update UI with saved data
        if (analyses.length > 0) {
            const lastAnalysis = analyses[analyses.length - 1];
            currentSkinType = lastAnalysis.skinType;
            skinAnalysis = lastAnalysis;
            showResults();
        }
        
        // Mark saved products as saved
        savedProducts.forEach(productId => {
            const btn = document.querySelector(`button[onclick="addToRoutine('${productId}')"]`);
            if (btn) {
                btn.innerHTML = '<i class="fas fa-check mr-2"></i>Saved';
                btn.classList.add('bg-green-500');
                btn.classList.remove('bg-gradient-to-r');
            }
        });
    }

    /* =========================================================
       ENHANCED PRODUCT DATABASE
    ========================================================== */
    const productDatabase = {
        'Acne-Prone Skin': {
            description: 'Products to control oil, reduce inflammation, and prevent breakouts',
            concerns: ['Breakouts', 'Excess Oil', 'Inflammation', 'Clogged Pores'],
            keyIngredients: ['Salicylic Acid', 'Niacinamide', 'Benzoyl Peroxide', 'Retinol'],
            morningRoutine: [
                { step: 1, product: 'Gentle Cleanser', type: 'Cleanser', purpose: 'Remove overnight oil without stripping', application: 'Massage for 30 seconds, rinse with cool water', timing: 'Daily' },
                { step: 2, product: 'Niacinamide Serum', type: 'Treatment', purpose: 'Control oil production', application: '3-4 drops on oily areas', timing: 'Daily' },
                { step: 3, product: 'Lightweight Moisturizer', type: 'Moisturizer', purpose: 'Hydrate without clogging pores', application: 'Pea-sized amount, avoid heavy application', timing: 'Daily' },
                { step: 4, product: 'Oil-Free Sunscreen', type: 'Sun Protection', purpose: 'Protect from UV damage', application: 'Apply 15 minutes before sun exposure', timing: 'Daily' }
            ],
            eveningRoutine: [
                { step: 1, product: 'Cleanser', type: 'Cleanser', purpose: 'Remove makeup and daily buildup', application: 'Double cleanse if wearing makeup', timing: 'Daily' },
                { step: 2, product: 'Exfoliating Treatment', type: 'Treatment', purpose: 'Unclog pores and prevent breakouts', application: 'Focus on problem areas, avoid eye area', timing: '3-4 times weekly' },
                { step: 3, product: 'Treatment Serum', type: 'Treatment', purpose: 'Target active breakouts', application: 'Spot treatment or all over face', timing: 'Daily' },
                { step: 4, product: 'Light Moisturizer', type: 'Moisturizer', purpose: 'Maintain skin barrier', application: 'Allow treatments to absorb first', timing: 'Daily' }
            ],
            products: [
                {
                    id: 'acne-budget-1',
                    name: 'CeraVe Acne Foaming Cream Cleanser',
                    brand: 'CeraVe',
                    price: '$14.99',
                    budget: 'affordable',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.6,
                    reviews: 12500,
                    description: '4% benzoyl peroxide cleanser for acne treatment',
                    ingredients: ['Benzoyl Peroxide 4%', 'Niacinamide', 'Ceramides'],
                    features: ['Oil-Free', 'Non-Comedogenic', 'Dermatologist Recommended'],
                    skinConcerns: ['Acne', 'Oil Control', 'Pore Minimizing'],
                    usage: 'Use morning and evening'
                },
                {
                    id: 'acne-budget-2',
                    name: 'The Ordinary Niacinamide 10% + Zinc 1%',
                    brand: 'The Ordinary',
                    price: '$6.80',
                    budget: 'affordable',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.5,
                    reviews: 45800,
                    description: 'Oil control and pore minimizing serum',
                    ingredients: ['Niacinamide 10%', 'Zinc PCA 1%'],
                    features: ['Vegan', 'Oil-Free', 'Fragrance-Free'],
                    skinConcerns: ['Oil Control', 'Pore Minimizing', 'Breakouts'],
                    usage: 'Use after cleansing, before moisturizer'
                },
                {
                    id: 'acne-premium-1',
                    name: 'Paula\'s Choice 2% BHA Liquid Exfoliant',
                    brand: 'Paula\'s Choice',
                    price: '$32.00',
                    budget: 'premium',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.7,
                    reviews: 15600,
                    description: 'Salicylic acid exfoliant for pore clearing',
                    ingredients: ['Salicylic Acid 2%', 'Green Tea Extract', 'Methylpropanediol'],
                    features: ['Fragrance-Free', 'Cruelty-Free', 'Dermatologist Recommended'],
                    skinConcerns: ['Blackheads', 'Enlarged Pores', 'Uneven Texture'],
                    usage: 'Use 2-3 times weekly after cleansing'
                },
                {
                    id: 'acne-premium-2',
                    name: 'SkinCeuticals Blemish + Age Defense',
                    brand: 'SkinCeuticals',
                    price: '$92.00',
                    budget: 'premium',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.6,
                    reviews: 1200,
                    description: 'Dual-action serum for acne and aging concerns',
                    ingredients: ['Salicylic Acid', 'Glycolic Acid', 'Dioic Acid'],
                    features: ['Oil-Free', 'Fragrance-Free', 'Clinical Grade'],
                    skinConcerns: ['Acne', 'Fine Lines', 'Uneven Tone'],
                    usage: 'Use once daily, gradually increase to twice daily'
                }
            ],
            scienceExplanations: [
                { title: "Salicylic Acid: The Pore-Clearing Powerhouse", content: "Salicylic Acid is a beta-hydroxy acid (BHA) that's oil-soluble, allowing it to penetrate deep into pores. It works by dissolving the 'glue' that holds dead skin cells together, preventing clogged pores and reducing existing blackheads and whiteheads." },
                { title: "Niacinamide: The Multi-Tasking Marvel", content: "Niacinamide (Vitamin B3) regulates sebum production, reduces inflammation, and strengthens the skin barrier. Studies show it can reduce acne lesions by up to 60% when used consistently." }
            ]
        },
        'Dry Skin': {
            description: 'Products to hydrate, repair barrier, and restore moisture balance',
            concerns: ['Dehydration', 'Flakiness', 'Tightness', 'Barrier Damage'],
            keyIngredients: ['Hyaluronic Acid', 'Ceramides', 'Squalane', 'Peptides'],
            morningRoutine: [
                { step: 1, product: 'Gentle Cream Cleanser', type: 'Cleanser', purpose: 'Cleanse without stripping natural oils', application: 'Massage gently, rinse with lukewarm water', timing: 'Daily' },
                { step: 2, product: 'Hydrating Toner/Essence', type: 'Hydrator', purpose: 'Prepare skin for better product absorption', application: 'Pat into damp skin', timing: 'Daily' },
                { step: 3, product: 'Hydrating Serum', type: 'Treatment', purpose: 'Deep hydration and moisture retention', application: 'Apply to damp skin, press gently', timing: 'Daily' },
                { step: 4, product: 'Rich Moisturizer', type: 'Moisturizer', purpose: 'Seal in hydration and repair barrier', application: 'Allow serums to absorb first', timing: 'Daily' },
                { step: 5, product: 'Facial Oil (Optional)', type: 'Occlusive', purpose: 'Extra protection and nourishment', application: '2-3 drops pressed into skin', timing: 'As needed' }
            ],
            eveningRoutine: [
                { step: 1, product: 'Cleansing Balm/Oil', type: 'Cleanser', purpose: 'Remove makeup and sunscreen', application: 'Massage onto dry skin, emulsify with water', timing: 'Daily' },
                { step: 2, product: 'Gentle Cleanser', type: 'Cleanser', purpose: 'Second cleanse to remove residue', application: 'Focus on massaging, not scrubbing', timing: 'Daily' },
                { step: 3, product: 'Treatment Serum', type: 'Treatment', purpose: 'Address specific concerns (aging, texture)', application: 'Wait 20 minutes after acids', timing: '3-4 times weekly' },
                { step: 4, product: 'Hydrating Serum', type: 'Treatment', purpose: 'Replenish moisture', application: 'Layer if using multiple serums', timing: 'Daily' },
                { step: 5, product: 'Night Cream', type: 'Moisturizer', purpose: 'Intensive overnight hydration', application: 'Generous amount, massage thoroughly', timing: 'Daily' }
            ],
            products: [
                {
                    id: 'dry-budget-1',
                    name: 'CeraVe Hydrating Facial Cleanser',
                    brand: 'CeraVe',
                    price: '$13.99',
                    budget: 'affordable',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.6,
                    reviews: 24500,
                    description: 'Gentle cleanser with ceramides and hyaluronic acid',
                    ingredients: ['Ceramides', 'Hyaluronic Acid', 'Glycerin'],
                    features: ['Fragrance-Free', 'Non-Comedogenic', 'Dermatologist Recommended'],
                    skinConcerns: ['Dryness', 'Dehydration', 'Barrier Repair'],
                    usage: 'Use morning and evening'
                },
                {
                    id: 'dry-budget-2',
                    name: 'The Ordinary Hyaluronic Acid 2% + B5',
                    brand: 'The Ordinary',
                    price: '$6.80',
                    budget: 'affordable',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.5,
                    reviews: 45800,
                    description: 'Hydration support formula with vitamin B5',
                    ingredients: ['Hyaluronic Acid', 'Vitamin B5', 'Crosspolymer'],
                    features: ['Vegan', 'Oil-Free', 'Alcohol-Free'],
                    skinConcerns: ['Dehydration', 'Fine Lines', 'Plumping'],
                    usage: 'Apply to damp skin morning and evening'
                },
                {
                    id: 'dry-premium-1',
                    name: 'SkinCeuticals Hydrating B5 Gel',
                    brand: 'SkinCeuticals',
                    price: '$86.00',
                    budget: 'premium',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.7,
                    reviews: 3400,
                    description: 'Oil-free hydrating serum with hyaluronic acid',
                    ingredients: ['Hyaluronic Acid', 'Vitamin B5', 'Phenoxyethanol'],
                    features: ['Oil-Free', 'Fragrance-Free', 'Clinical Grade'],
                    skinConcerns: ['Dehydration', 'Fine Lines', 'Sensitive Skin'],
                    usage: 'Use 2-3 drops morning and evening'
                },
                {
                    id: 'dry-premium-2',
                    name: 'Drunk Elephant Lala Retro Whipped Cream',
                    brand: 'Drunk Elephant',
                    price: '$60.00',
                    budget: 'premium',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.5,
                    reviews: 5600,
                    description: 'Whipped moisturizer with African oils and ceramides',
                    ingredients: ['African Oils', 'Ceramides', 'Hyaluronic Acid', 'Antioxidants'],
                    features: ['Cruelty-Free', 'Fragrance-Free', 'Silicone-Free'],
                    skinConcerns: ['Dryness', 'Barrier Repair', 'Anti-Aging'],
                    usage: 'Use as final step morning and evening'
                }
            ],
            scienceExplanations: [
                { title: "Hyaluronic Acid: The Moisture Magnet", content: "Hyaluronic Acid can hold up to 1000 times its weight in water, making it a powerful humectant. It draws moisture from the environment into the skin, providing immediate plumping and long-term hydration benefits." },
                { title: "Ceramides: The Skin Barrier Builders", content: "Ceramides are lipids that make up 50% of the skin's barrier. They act like mortar between skin cells, preventing moisture loss and protecting against environmental damage. Dry skin often lacks sufficient ceramides." }
            ]
        },
        'Combination Skin': {
            description: 'Products that balance oil production while hydrating dry areas',
            concerns: ['Oily T-zone', 'Dry Cheeks', 'Enlarged Pores', 'Uneven Texture'],
            keyIngredients: ['Niacinamide', 'Hyaluronic Acid', 'Salicylic Acid', 'Ceramides'],
            morningRoutine: [
                { step: 1, product: 'Gentle Gel Cleanser', type: 'Cleanser', purpose: 'Balance cleansing without over-drying', application: 'Focus on T-zone, gentle on cheeks', timing: 'Daily' },
                { step: 2, product: 'Balancing Toner', type: 'Toner', purpose: 'Prepare skin and balance pH', application: 'Apply with hands, pat gently', timing: 'Daily' },
                { step: 3, product: 'Niacinamide Serum', type: 'Treatment', purpose: 'Regulate oil production', application: 'Focus on oily areas, light layer on dry areas', timing: 'Daily' },
                { step: 4, product: 'Lightweight Moisturizer', type: 'Moisturizer', purpose: 'Hydrate without heaviness', application: 'Adjust amount based on facial zones', timing: 'Daily' },
                { step: 5, product: 'Mattifying Sunscreen', type: 'Sun Protection', purpose: 'Control shine and protect', application: 'Focus on T-zone for mattifying effect', timing: 'Daily' }
            ],
            eveningRoutine: [
                { step: 1, product: 'Cleansing Oil/Gel', type: 'Cleanser', purpose: 'Remove makeup and sunscreen', application: 'Massage thoroughly, especially on oily areas', timing: 'Daily' },
                { step: 2, product: 'Gentle Cleanser', type: 'Cleanser', purpose: 'Second cleanse for thorough cleaning', application: 'Gentle massage, avoid over-cleansing dry areas', timing: 'Daily' },
                { step: 3, product: 'BHA Treatment', type: 'Exfoliant', purpose: 'Unclog pores in oily areas', application: 'Apply only to T-zone if cheeks are sensitive', timing: '3-4 times weekly' },
                { step: 4, product: 'Hydrating Serum', type: 'Treatment', purpose: 'Address dry cheek areas', application: 'Focus on dry areas, light layer elsewhere', timing: 'Daily' },
                { step: 5, product: 'Balancing Moisturizer', type: 'Moisturizer', purpose: 'Hydrate without clogging', application: 'More on dry areas, less on oily areas', timing: 'Daily' }
            ],
            products: [
                {
                    id: 'combo-budget-1',
                    name: 'Cetaphil Daily Facial Cleanser',
                    brand: 'Cetaphil',
                    price: '$11.99',
                    budget: 'affordable',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.4,
                    reviews: 18200,
                    description: 'Gentle cleanser for combination skin',
                    ingredients: ['Glycerin', 'Niacinamide', 'Panthenol'],
                    features: ['Soap-Free', 'Non-Comedogenic', 'Dermatologist Recommended'],
                    skinConcerns: ['Combination Skin', 'Gentle Cleansing', 'pH Balance'],
                    usage: 'Use morning and evening'
                },
                {
                    id: 'combo-budget-2',
                    name: 'The Ordinary Niacinamide 10% + Zinc 1%',
                    brand: 'The Ordinary',
                    price: '$6.80',
                    budget: 'affordable',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.5,
                    reviews: 45800,
                    description: 'Oil control and pore minimizing serum',
                    ingredients: ['Niacinamide 10%', 'Zinc PCA 1%'],
                    features: ['Vegan', 'Oil-Free', 'Fragrance-Free'],
                    skinConcerns: ['Oil Control', 'Pore Minimizing', 'Breakout Prevention'],
                    usage: 'Use after cleansing, focus on T-zone'
                },
                {
                    id: 'combo-premium-1',
                    name: 'Youth to the People Superfood Cleanser',
                    brand: 'Youth to the People',
                    price: '$36.00',
                    budget: 'premium',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.6,
                    reviews: 8900,
                    description: 'Cold-pressed antioxidants rich cleanser',
                    ingredients: ['Kale', 'Spinach', 'Green Tea', 'Vitamins'],
                    features: ['Vegan', 'Cruelty-Free', 'Cold-Pressed'],
                    skinConcerns: ['Combination Skin', 'Antioxidant Protection', 'Gentle Cleansing'],
                    usage: 'Use morning and evening'
                },
                {
                    id: 'combo-premium-2',
                    name: 'Tatcha The Water Cream',
                    brand: 'Tatcha',
                    price: '$68.00',
                    budget: 'premium',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.5,
                    reviews: 3400,
                    description: 'Oil-free anti-aging water cream',
                    ingredients: ['Japanese Wild Rose', 'Hadasei-3 Complex', 'Tatcha\'s Signature'],
                    features: ['Oil-Free', 'Non-Comedogenic', 'Anti-Aging'],
                    skinConcerns: ['Combination Skin', 'Pore Refining', 'Anti-Aging'],
                    usage: 'Use morning and evening'
                }
            ],
            scienceExplanations: [
                { title: "Zone-Based Skincare Science", content: "Combination skin requires different approaches for different facial zones. The T-zone has more sebaceous glands per square inch than other facial areas, requiring oil control, while cheeks need hydration support." },
                { title: "Niacinamide: The Balancing Act", content: "Niacinamide helps regulate sebum production in oily areas while strengthening the skin barrier in dry areas. It's particularly effective for combination skin as it addresses multiple concerns simultaneously." }
            ]
        },
        'Normal Skin': {
            description: 'Products to maintain balance and provide preventive care',
            concerns: ['Maintenance', 'Prevention', 'Environmental Protection', 'Healthy Glow'],
            keyIngredients: ['Vitamin C', 'Peptides', 'Antioxidants', 'Hyaluronic Acid'],
            morningRoutine: [
                { step: 1, product: 'Gentle Cleanser', type: 'Cleanser', purpose: 'Refresh skin and remove overnight impurities', application: 'Gentle circular motions, rinse with lukewarm water', timing: 'Daily' },
                { step: 2, product: 'Vitamin C Serum', type: 'Antioxidant', purpose: 'Protect against environmental damage', application: 'Apply to clean, dry skin', timing: 'Daily' },
                { step: 3, product: 'Light Moisturizer', type: 'Moisturizer', purpose: 'Maintain hydration balance', application: 'Pea-sized amount, massage gently', timing: 'Daily' },
                { step: 4, product: 'Broad Spectrum Sunscreen', type: 'Sun Protection', purpose: 'Prevent premature aging and damage', application: 'Apply 15 minutes before sun exposure', timing: 'Daily' }
            ],
            eveningRoutine: [
                { step: 1, product: 'Cleansing Balm/Gel', type: 'Cleanser', purpose: 'Remove makeup, sunscreen, and daily buildup', application: 'Massage thoroughly, especially on sunscreen areas', timing: 'Daily' },
                { step: 2, product: 'Treatment Serum', type: 'Treatment', purpose: 'Address specific concerns (anti-aging, texture)', application: 'Allow to absorb completely', timing: '3-4 times weekly' },
                { step: 3, product: 'Hydrating Serum', type: 'Hydration', purpose: 'Maintain optimal moisture levels', application: 'Apply while skin is still slightly damp', timing: 'Daily' },
                { step: 4, product: 'Night Moisturizer', type: 'Moisturizer', purpose: 'Support overnight skin repair', application: 'Generous amount, allow to absorb', timing: 'Daily' }
            ],
            products: [
                {
                    id: 'normal-budget-1',
                    name: 'Vanicream Gentle Facial Cleanser',
                    brand: 'Vanicream',
                    price: '$8.99',
                    budget: 'affordable',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.6,
                    reviews: 12300,
                    description: 'Gentle cleanser for sensitive normal skin',
                    ingredients: ['Glycerin', 'Purified Water', 'Cocoyl Glycinate'],
                    features: ['Fragrance-Free', 'Soap-Free', 'Dermatologist Recommended'],
                    skinConcerns: ['Gentle Cleansing', 'Sensitive Skin', 'Daily Use'],
                    usage: 'Use morning and evening'
                },
                {
                    id: 'normal-budget-2',
                    name: 'The Ordinary Vitamin C Suspension 23%',
                    brand: 'The Ordinary',
                    price: '$5.80',
                    budget: 'affordable',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.3,
                    reviews: 28900,
                    description: 'Direct vitamin C for brightening',
                    ingredients: ['Vitamin C 23%', 'Hyaluronic Acid', 'Silicone'],
                    features: ['Vegan', 'Cruelty-Free', 'Direct Vitamin C'],
                    skinConcerns: ['Brightening', 'Anti-Aging', 'Antioxidant Protection'],
                    usage: 'Use in morning, can be mixed with moisturizer'
                },
                {
                    id: 'normal-premium-1',
                    name: 'SkinCeuticals C E Ferulic',
                    brand: 'SkinCeuticals',
                    price: '$169.00',
                    budget: 'premium',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.8,
                    reviews: 4200,
                    description: 'Advanced antioxidant vitamin C serum',
                    ingredients: ['Vitamin C 15%', 'Vitamin E', 'Ferulic Acid'],
                    features: ['Clinical Results', 'Patented Formula', 'Dermatologist Developed'],
                    skinConcerns: ['Anti-Aging', 'Environmental Protection', 'Brightening'],
                    usage: 'Use 4-5 drops in morning after cleansing'
                },
                {
                    id: 'normal-premium-2',
                    name: 'Drunk Elephant Protini Polypeptide Cream',
                    brand: 'Drunk Elephant',
                    price: '$68.00',
                    budget: 'premium',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.6,
                    reviews: 7800,
                    description: 'Protein moisturizer with peptides and amino acids',
                    ingredients:: 'Balancing Moisturizer', type: 'Moisturizer', purpose: 'Hydrate without clogging', application: 'More on dry areas, less on oily areas', timing: 'Daily' }
            ],
            products: [
                {
                    id: 'combo-budget-1',
                    name: 'Cetaphil Daily Facial Cleanser',
                    brand: 'Cetaphil',
                    price: '$11.99',
                    budget: 'affordable',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.4,
                    reviews: 18200,
                    description: 'Gentle cleanser for combination skin',
                    ingredients: ['Glycerin', 'Niacinamide', 'Panthenol'],
                    features: ['Soap-Free', 'Non-Comedogenic', 'Dermatologist Recommended'],
                    skinConcerns: ['Combination Skin', 'Gentle Cleansing', 'pH Balance'],
                    usage: 'Use morning and evening'
                },
                {
                    id: 'combo-budget-2',
                    name: 'The Ordinary Niacinamide 10% + Zinc 1%',
                    brand: 'The Ordinary',
                    price: '$6.80',
                    budget: 'affordable',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.5,
                    reviews: 45800,
                    description: 'Oil control and pore minimizing serum',
                    ingredients: ['Niacinamide 10%', 'Zinc PCA 1%'],
                    features: ['Vegan', 'Oil-Free', 'Fragrance-Free'],
                    skinConcerns: ['Oil Control', 'Pore Minimizing', 'Breakout Prevention'],
                    usage: 'Use after cleansing, focus on T-zone'
                },
                {
                    id: 'combo-premium-1',
                    name: 'Youth to the People Superfood Cleanser',
                    brand: 'Youth to the People',
                    price: '$36.00',
                    budget: 'premium',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.6,
                    reviews: 8900,
                    description: 'Cold-pressed antioxidants rich cleanser',
                    ingredients: ['Kale', 'Spinach', 'Green Tea', 'Vitamins'],
                    features: ['Vegan', 'Cruelty-Free', 'Cold-Pressed'],
                    skinConcerns: ['Combination Skin', 'Antioxidant Protection', 'Gentle Cleansing'],
                    usage: 'Use morning and evening'
                },
                {
                    id: 'combo-premium-2',
                    name: 'Tatcha The Water Cream',
                    brand: 'Tatcha',
                    price: '$68.00',
                    budget: 'premium',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.5,
                    reviews: 3400,
                    description: 'Oil-free anti-aging water cream',
                    ingredients: ['Japanese Wild Rose', 'Hadasei-3 Complex', 'Tatcha\'s Signature'],
                    features: ['Oil-Free', 'Non-Comedogenic', 'Anti-Aging'],
                    skinConcerns: ['Combination Skin', 'Pore Refining', 'Anti-Aging'],
                    usage: 'Use morning and evening'
                }
            ],
            scienceExplanations: [
                { title: "Zone-Based Skincare Science", content: "Combination skin requires different approaches for different facial zones. The T-zone has more sebaceous glands per square inch than other facial areas, requiring oil control, while cheeks need hydration support." },
                { title: "Niacinamide: The Balancing Act", content: "Niacinamide helps regulate sebum production in oily areas while strengthening the skin barrier in dry areas. It's particularly effective for combination skin as it addresses multiple concerns simultaneously." }
            ]
        },
        'Normal Skin': {
            description: 'Products to maintain balance and provide preventive care',
            concerns: ['Maintenance', 'Prevention', 'Environmental Protection', 'Healthy Glow'],
            keyIngredients: ['Vitamin C', 'Peptides', 'Antioxidants', 'Hyaluronic Acid'],
            morningRoutine: [
                { step: 1, product: 'Gentle Cleanser', type: 'Cleanser', purpose: 'Refresh skin and remove overnight impurities', application: 'Gentle circular motions, rinse with lukewarm water', timing: 'Daily' },
                { step: 2, product: 'Vitamin C Serum', type: 'Antioxidant', purpose: 'Protect against environmental damage', application: 'Apply to clean, dry skin', timing: 'Daily' },
                { step: 3, product: 'Light Moisturizer', type: 'Moisturizer', purpose: 'Maintain hydration balance', application: 'Pea-sized amount, massage gently', timing: 'Daily' },
                { step: 4, product: 'Broad Spectrum Sunscreen', type: 'Sun Protection', purpose: 'Prevent premature aging and damage', application: 'Apply 15 minutes before sun exposure', timing: 'Daily' }
            ],
            eveningRoutine: [
                { step: 1, product: 'Cleansing Balm/Gel', type: 'Cleanser', purpose: 'Remove makeup, sunscreen, and daily buildup', application: 'Massage thoroughly, especially on sunscreen areas', timing: 'Daily' },
                { step: 2, product: 'Treatment Serum', type: 'Treatment', purpose: 'Address specific concerns (anti-aging, texture)', application: 'Allow to absorb completely', timing: '3-4 times weekly' },
                { step: 3, product: 'Hydrating Serum', type: 'Hydration', purpose: 'Maintain optimal moisture levels', application: 'Apply while skin is still slightly damp', timing: 'Daily' },
                { step: 4, product: 'Night Moisturizer', type: 'Moisturizer', purpose: 'Support overnight skin repair', application: 'Generous amount, allow to absorb', timing: 'Daily' }
            ],
            products: [
                {
                    id: 'normal-budget-1',
                    name: 'Vanicream Gentle Facial Cleanser',
                    brand: 'Vanicream',
                    price: '$8.99',
                    budget: 'affordable',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.6,
                    reviews: 12300,
                    description: 'Gentle cleanser for sensitive normal skin',
                    ingredients: ['Glycerin', 'Purified Water', 'Cocoyl Glycinate'],
                    features: ['Fragrance-Free', 'Soap-Free', 'Dermatologist Recommended'],
                    skinConcerns: ['Gentle Cleansing', 'Sensitive Skin', 'Daily Use'],
                    usage: 'Use morning and evening'
                },
                {
                    id: 'normal-budget-2',
                    name: 'The Ordinary Vitamin C Suspension 23%',
                    brand: 'The Ordinary',
                    price: '$5.80',
                    budget: 'affordable',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.3,
                    reviews: 28900,
                    description: 'Direct vitamin C for brightening',
                    ingredients: ['Vitamin C 23%', 'Hyaluronic Acid', 'Silicone'],
                    features: ['Vegan', 'Cruelty-Free', 'Direct Vitamin C'],
                    skinConcerns: ['Brightening', 'Anti-Aging', 'Antioxidant Protection'],
                    usage: 'Use in morning, can be mixed with moisturizer'
                },
                {
                    id: 'normal-premium-1',
                    name: 'SkinCeuticals C E Ferulic',
                    brand: 'SkinCeuticals',
                    price: '$169.00',
                    budget: 'premium',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.8,
                    reviews: 4200,
                    description: 'Advanced antioxidant vitamin C serum',
                    ingredients: ['Vitamin C 15%', 'Vitamin E', 'Ferulic Acid'],
                    features: ['Clinical Results', 'Patented Formula', 'Dermatologist Developed'],
                    skinConcerns: ['Anti-Aging', 'Environmental Protection', 'Brightening'],
                    usage: 'Use 4-5 drops in morning after cleansing'
                },
                {
                    id: 'normal-premium-2',
                    name: 'Drunk Elephant Protini Polypeptide Cream',
                    brand: 'Drunk Elephant',
                    price: '$68.00',
                    budget: 'premium',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.6,
                    reviews: 7800,
                    description: 'Protein moisturizer with peptides and amino acids',
                    ingredients: ['Signal Peptides', 'Growth Factors', 'Amino Acids', 'Pygmy Waterlily'],
                    features: ['Vegan', 'Cruelty-Free', 'Silicone-Free'],
                    skinConcerns: ['Firmness', 'Elasticity', 'Protein Support'],
                    usage: 'Use morning and evening'
                }
            ],
            scienceExplanations: [
                { title: "Preventive Skincare Science", content: "Normal skin is the ideal baseline - balanced oil production, adequate hydration, and minimal concerns. The focus should be on prevention rather than treatment, using antioxidants to protect against environmental damage." },
                { title: "Vitamin C: The Master Antioxidant", content: "Vitamin C neutralizes free radicals from UV exposure and pollution, stimulates collagen production, and inhibits melanin synthesis. It's essential for preventing premature aging in normal skin." }
            ]
        },
        'Sensitive Skin': {
            description: 'Gentle products to calm, soothe, and strengthen sensitive skin',
            concerns: ['Redness', 'Irritation', 'Reactivity', 'Barrier Weakness', 'Stinging'],
            keyIngredients: ['Centella Asiatica', 'Ceramides', 'Niacinamide', 'Oat Extract', 'Aloe Vera'],
            morningRoutine: [
                { step: 1, product: 'Ultra-Gentle Cleanser', type: 'Cleanser', purpose: 'Cleanse without disrupting skin barrier', application: '10-second contact time maximum', timing: 'Daily' },
                { step: 2, product: 'Calming Toner/Essence', type: 'Soother', purpose: 'Reduce redness and prepare skin', application: 'Pat gently with hands, no rubbing', timing: 'Daily' },
                { step: 3, product: 'Barrier Repair Serum', type: 'Treatment', purpose: 'Strengthen skin barrier', application: 'Apply to slightly damp skin', timing: 'Daily' },
                { step: 4, product: 'Gentle Moisturizer', type: 'Moisturizer', purpose: 'Provide protection and hydration', application: 'Gentle pressing motion', timing: 'Daily' },
                { step: 5, product: 'Mineral Sunscreen', type: 'Sun Protection', purpose: 'Physical protection without irritation', application: 'Pat gently, avoid rubbing', timing: 'Daily' }
            ],
            eveningRoutine: [
                { step: 1, product: 'Micellar Water/Cleansing Milk', type: 'Cleanser', purpose: 'Remove makeup and impurities gently', application: 'Soak cotton pad, gentle swipes', timing: 'Daily' },
                { step: 2, product: 'Gentle Cream Cleanser', type: 'Cleanser', purpose: 'Second cleanse without stripping', application: 'Minimal contact time, cool water', timing: 'Daily' },
                { step: 3, product: 'Calming Treatment', type: 'Treatment', purpose: 'Reduce inflammation and redness', application: 'Wait for skin to calm between steps', timing: 'Daily' },
                { step: 4, product: 'Rich Moisturizer', type: 'Moisturizer', purpose: 'Intensive barrier support', application: 'Generous amount, gentle application', timing: 'Daily' },
                { step: 5, product: 'Facial Oil (Optional)', type: 'Occlusive', purpose: 'Extra barrier protection', application: '2-3 drops, press gently', timing: 'As needed' }
            ],
            products: [
                {
                    id: 'sensitive-budget-1',
                    name: 'Avene Tolerance Control Cleanser',
                    brand: 'Avene',
                    price: '$32.00',
                    budget: 'affordable',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.5,
                    reviews: 8900,
                    description: 'Ultra-gentle cleanser for reactive skin',
                    ingredients: ['Thermal Spring Water', 'Dexpanthanol', 'Ceramides'],
                    features: ['Sterile Formula', 'Fragrance-Free', 'Paraben-Free'],
                    skinConcerns: ['Sensitivity', 'Redness', 'Barrier Repair'],
                    usage: 'Use morning and evening, minimal contact time'
                },
                {
                    id: 'sensitive-budget-2',
                    name: 'La Roche-Posay Toleriane Sensitive Fluide',
                    brand: 'La Roche-Posay',
                    price: '$24.99',
                    budget: 'affordable',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.4,
                    reviews: 12300,
                    description: 'Minimalist formula for sensitive skin',
                    ingredients: ['Thermal Spring Water', 'Glycerin', 'Squalane'],
                    features: ['Minimal Ingredients', 'Fragrance-Free', 'Non-Comedogenic'],
                    skinConcerns: ['Sensitivity', 'Basic Hydration', 'Minimal Irritation'],
                    usage: 'Use morning and evening'
                },
                {
                    id: 'sensitive-premium-1',
                    name: 'Drunk Elephant Lala Retro Whipped Cream',
                    brand: 'Drunk Elephant',
                    price: '$60.00',
                    budget: 'premium',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.5,
                    reviews: 5600,
                    description: 'Whipped moisturizer with African oils',
                    ingredients: ['African Oils', 'Ceramides', 'Hyaluronic Acid'],
                    features: ['Cruelty-Free', 'Fragrance-Free', 'Silicone-Free'],
                    skinConcerns: ['Barrier Repair', 'Intensive Moisture', 'Gentle Care'],
                    usage: 'Use as needed for intensive moisture'
                },
                {
                    id: 'sensitive-premium-2',
                    name: 'Tatcha The Indigo Cream',
                    brand: 'Tatcha',
                    price: '$85.00',
                    budget: 'premium',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.7,
                    reviews: 2100,
                    description: 'Anti-redness cream with indigo extract',
                    ingredients: ['Japanese Indigo', 'Hadasei-3 Complex', 'Colloidal Oatmeal'],
                    features: ['Natural Ingredients', 'Anti-Redness', 'Luxury Formula'],
                    skinConcerns: ['Redness', 'Sensitivity', 'Luxury Care'],
                    usage: 'Use morning and evening'
                }
            ],
            scienceExplanations: [
                { title: "Understanding Skin Reactivity", content: "Sensitive skin has a compromised barrier function and heightened nerve responses. The stratum corneum is thinner, allowing irritants to penetrate more easily and trigger inflammatory responses." },
                { title: "The Importance of pH Balance", content: "Sensitive skin often has an altered pH level. Healthy skin pH is around 4.7-5.5. Using pH-balanced products helps maintain the acid mantle, which protects against pathogens and irritation." }
            ]
        }
    };

    /* =========================================================
       DATA PERSISTENCE HELPERS
    ========================================================== */
    function getUserData() {
        if (!currentUser) return null;
        const raw = localStorage.getItem(`data_${currentUser.email}`);
        return raw ? JSON.parse(raw) : { analyses: [], savedProducts: [], photos: [] };
    }

    function saveUserData(data) {
        if (!currentUser) return;
        localStorage.setItem(`data_${currentUser.email}`, JSON.stringify(data));
    }

    function saveAnalysis() {
        if (!currentUser) return;
        const data = getUserData();
        data.analyses.push({
            date: new Date().toISOString(),
            skinType: currentSkinType,
            concerns: skinAnalysis.concerns,
            confidence: skinAnalysis.confidence
        });
        saveUserData(data);
        
        // Also update user object
        currentUser.analyses = data.analyses;
        localStorage.setItem('skincastUser', JSON.stringify(currentUser));
    }

    function addToRoutine(productId) {
        if (!currentUser) {
            showNotification('Please login to save products', 'warning');
            return;
        }
        const data = getUserData();
        if (data.savedProducts.includes(productId)) {
            showNotification('Product already in your routine', 'info');
            return;
        }
        data.savedProducts.push(productId);
        saveUserData(data);
        
        // Update user object
        currentUser.savedProducts = data.savedProducts;
        localStorage.setItem('skincastUser', JSON.stringify(currentUser));
        
        // Update button
        const btn = event.target;
        btn.innerHTML = '<i class="fas fa-check mr-2"></i>Saved';
        btn.classList.remove('bg-gradient-to-r', 'from-purple-500', 'to-blue-500');
        btn.classList.add('bg-green-500');
        
        showNotification('Product added to your routine!', 'success');
    }

    /* =========================================================
       CAMERA & SCAN ANIMATION
    ========================================================== */
    async function: 'Balancing Moisturizer', type: 'Moisturizer', purpose: 'Hydrate without clogging', application: 'More on dry areas, less on oily areas', timing: 'Daily' }
            ],
            products: [
                {
                    id: 'combo-budget-1',
                    name: 'Cetaphil Daily Facial Cleanser',
                    brand: 'Cetaphil',
                    price: '$11.99',
                    budget: 'affordable',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.4,
                    reviews: 18200,
                    description: 'Gentle cleanser for combination skin',
                    ingredients: ['Glycerin', 'Niacinamide', 'Panthenol'],
                    features: ['Soap-Free', 'Non-Comedogenic', 'Dermatologist Recommended'],
                    skinConcerns: ['Combination Skin', 'Gentle Cleansing', 'pH Balance'],
                    usage: 'Use morning and evening'
                },
                {
                    id: 'combo-budget-2',
                    name: 'The Ordinary Niacinamide 10% + Zinc 1%',
                    brand: 'The Ordinary',
                    price: '$6.80',
                    budget: 'affordable',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.5,
                    reviews: 45800,
                    description: 'Oil control and pore minimizing serum',
                    ingredients: ['Niacinamide 10%', 'Zinc PCA 1%'],
                    features: ['Vegan', 'Oil-Free', 'Fragrance-Free'],
                    skinConcerns: ['Oil Control', 'Pore Minimizing', 'Breakout Prevention'],
                    usage: 'Use after cleansing, focus on T-zone'
                },
                {
                    id: 'combo-premium-1',
                    name: 'Youth to the People Superfood Cleanser',
                    brand: 'Youth to the People',
                    price: '$36.00',
                    budget: 'premium',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.6,
                    reviews: 8900,
                    description: 'Cold-pressed antioxidants rich cleanser',
                    ingredients: ['Kale', 'Spinach', 'Green Tea', 'Vitamins'],
                    features: ['Vegan', 'Cruelty-Free', 'Cold-Pressed'],
                    skinConcerns: ['Combination Skin', 'Antioxidant Protection', 'Gentle Cleansing'],
                    usage: 'Use morning and evening'
                },
                {
                    id: 'combo-premium-2',
                    name: 'Tatcha The Water Cream',
                    brand: 'Tatcha',
                    price: '$68.00',
                    budget: 'premium',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.5,
                    reviews: 3400,
                    description: 'Oil-free anti-aging water cream',
                    ingredients: ['Japanese Wild Rose', 'Hadasei-3 Complex', 'Tatcha\'s Signature'],
                    features: ['Oil-Free', 'Non-Comedogenic', 'Anti-Aging'],
                    skinConcerns: ['Combination Skin', 'Pore Refining', 'Anti-Aging'],
                    usage: 'Use morning and evening'
                }
            ],
            scienceExplanations: [
                { title: "Zone-Based Skincare Science", content: "Combination skin requires different approaches for different facial zones. The T-zone has more sebaceous glands per square inch than other facial areas, requiring oil control, while cheeks need hydration support." },
                { title: "Niacinamide: The Balancing Act", content: "Niacinamide helps regulate sebum production in oily areas while strengthening the skin barrier in dry areas. It's particularly effective for combination skin as it addresses multiple concerns simultaneously." }
            ]
        },
        'Normal Skin': {
            description: 'Products to maintain balance and provide preventive care',
            concerns: ['Maintenance', 'Prevention', 'Environmental Protection', 'Healthy Glow'],
            keyIngredients: ['Vitamin C', 'Peptides', 'Antioxidants', 'Hyaluronic Acid'],
            morningRoutine: [
                { step: 1, product: 'Gentle Cleanser', type: 'Cleanser', purpose: 'Refresh skin and remove overnight impurities', application: 'Gentle circular motions, rinse with lukewarm water', timing: 'Daily' },
                { step: 2, product: 'Vitamin C Serum', type: 'Antioxidant', purpose: 'Protect against environmental damage', application: 'Apply to clean, dry skin', timing: 'Daily' },
                { step: 3, product: 'Light Moisturizer', type: 'Moisturizer', purpose: 'Maintain hydration balance', application: 'Pea-sized amount, massage gently', timing: 'Daily' },
                { step: 4, product: 'Broad Spectrum Sunscreen', type: 'Sun Protection', purpose: 'Prevent premature aging and damage', application: 'Apply 15 minutes before sun exposure', timing: 'Daily' }
            ],
            eveningRoutine: [
                { step: 1, product: 'Cleansing Balm/Gel', type: 'Cleanser', purpose: 'Remove makeup, sunscreen, and daily buildup', application: 'Massage thoroughly, especially on sunscreen areas', timing: 'Daily' },
                { step: 2, product: 'Treatment Serum', type: 'Treatment', purpose: 'Address specific concerns (anti-aging, texture)', application: 'Allow to absorb completely', timing: '3-4 times weekly' },
                { step: 3, product: 'Hydrating Serum', type: 'Hydration', purpose: 'Maintain optimal moisture levels', application: 'Apply while skin is still slightly damp', timing: 'Daily' },
                { step: 4, product: 'Night Moisturizer', type: 'Moisturizer', purpose: 'Support overnight skin repair', application: 'Generous amount, allow to absorb', timing: 'Daily' }
            ],
            products: [
                {
                    id: 'normal-budget-1',
                    name: 'Vanicream Gentle Facial Cleanser',
                    brand: 'Vanicream',
                    price: '$8.99',
                    budget: 'affordable',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.6,
                    reviews: 12300,
                    description: 'Gentle cleanser for sensitive normal skin',
                    ingredients: ['Glycerin', 'Purified Water', 'Cocoyl Glycinate'],
                    features: ['Fragrance-Free', 'Soap-Free', 'Dermatologist Recommended'],
                    skinConcerns: ['Gentle Cleansing', 'Sensitive Skin', 'Daily Use'],
                    usage: 'Use morning and evening'
                },
                {
                    id: 'normal-budget-2',
                    name: 'The Ordinary Vitamin C Suspension 23%',
                    brand: 'The Ordinary',
                    price: '$5.80',
                    budget: 'affordable',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.3,
                    reviews: 28900,
                    description: 'Direct vitamin C for brightening',
                    ingredients: ['Vitamin C 23%', 'Hyaluronic Acid', 'Silicone'],
                    features: ['Vegan', 'Cruelty-Free', 'Direct Vitamin C'],
                    skinConcerns: ['Brightening', 'Anti-Aging', 'Antioxidant Protection'],
                    usage: 'Use in morning, can be mixed with moisturizer'
                },
                {
                    id: 'normal-premium-1',
                    name: 'SkinCeuticals C E Ferulic',
                    brand: 'SkinCeuticals',
                    price: '$169.00',
                    budget: 'premium',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.8,
                    reviews: 4200,
                    description: 'Advanced antioxidant vitamin C serum',
                    ingredients: ['Vitamin C 15%', 'Vitamin E', 'Ferulic Acid'],
                    features: ['Clinical Results', 'Patented Formula', 'Dermatologist Developed'],
                    skinConcerns: ['Anti-Aging', 'Environmental Protection', 'Brightening'],
                    usage: 'Use 4-5 drops in morning after cleansing'
                },
                {
                    id: 'normal-premium-2',
                    name: 'Drunk Elephant Protini Polypeptide Cream',
                    brand: 'Drunk Elephant',
                    price: '$68.00',
                    budget: 'premium',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.6,
                    reviews: 7800,
                    description: 'Protein moisturizer with peptides and amino acids',
                    ingredients: ['Signal Peptides', 'Growth Factors', 'Amino Acids', 'Pygmy Waterlily'],
                    features: ['Vegan', 'Cruelty-Free', 'Silicone-Free'],
                    skinConcerns: ['Firmness', 'Elasticity', 'Protein Support'],
                    usage: 'Use morning and evening'
                }
            ],
            scienceExplanations: [
                { title: "Preventive Skincare Science", content: "Normal skin is the ideal baseline - balanced oil production, adequate hydration, and minimal concerns. The focus should be on prevention rather than treatment, using antioxidants to protect against environmental damage." },
                { title: "Vitamin C: The Master Antioxidant", content: "Vitamin C neutralizes free radicals from UV exposure and pollution, stimulates collagen production, and inhibits melanin synthesis. It's essential for preventing premature aging in normal skin." }
            ]
        },
        'Sensitive Skin': {
            description: 'Gentle products to calm, soothe, and strengthen sensitive skin',
            concerns: ['Redness', 'Irritation', 'Reactivity', 'Barrier Weakness', 'Stinging'],
            keyIngredients: ['Centella Asiatica', 'Ceramides', 'Niacinamide', 'Oat Extract', 'Aloe Vera'],
            morningRoutine: [
                { step: 1, product: 'Ultra-Gentle Cleanser', type: 'Cleanser', purpose: 'Cleanse without disrupting skin barrier', application: '10-second contact time maximum', timing: 'Daily' },
                { step: 2, product: 'Calming Toner/Essence', type: 'Soother', purpose: 'Reduce redness and prepare skin', application: 'Pat gently with hands, no rubbing', timing: 'Daily' },
                { step: 3, product: 'Barrier Repair Serum', type: 'Treatment', purpose: 'Strengthen skin barrier', application: 'Apply to slightly damp skin', timing: 'Daily' },
                { step: 4, product: 'Gentle Moisturizer', type: 'Moisturizer', purpose: 'Provide protection and hydration', application: 'Gentle pressing motion', timing: 'Daily' },
                { step: 5, product: 'Mineral Sunscreen', type: 'Sun Protection', purpose: 'Physical protection without irritation', application: 'Pat gently, avoid rubbing', timing: 'Daily' }
            ],
            eveningRoutine: [
                { step: 1, product: 'Micellar Water/Cleansing Milk', type: 'Cleanser', purpose: 'Remove makeup and impurities gently', application: 'Soak cotton pad, gentle swipes', timing: 'Daily' },
                { step: 2, product: 'Gentle Cream Cleanser', type: 'Cleanser', purpose: 'Second cleanse without stripping', application: 'Minimal contact time, cool water', timing: 'Daily' },
                { step: 3, product: 'Calming Treatment', type: 'Treatment', purpose: 'Reduce inflammation and redness', application: 'Wait for skin to calm between steps', timing: 'Daily' },
                { step: 4, product: 'Rich Moisturizer', type: 'Moisturizer', purpose: 'Intensive barrier support', application: 'Generous amount, gentle application', timing: 'Daily' },
                { step: 5, product: 'Facial Oil (Optional)', type: 'Occlusive', purpose: 'Extra barrier protection', application: '2-3 drops, press gently', timing: 'As needed' }
            ],
            products: [
                {
                    id: 'sensitive-budget-1',
                    name: 'Avene Tolerance Control Cleanser',
                    brand: 'Avene',
                    price: '$32.00',
                    budget: 'affordable',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.5,
                    reviews: 8900,
                    description: 'Ultra-gentle cleanser for reactive skin',
                    ingredients: ['Thermal Spring Water', 'Dexpanthanol', 'Ceramides'],
                    features: ['Sterile Formula', 'Fragrance-Free', 'Paraben-Free'],
                    skinConcerns: ['Sensitivity', 'Redness', 'Barrier Repair'],
                    usage: 'Use morning and evening, minimal contact time'
                },
                {
                    id: 'sensitive-budget-2',
                    name: 'La Roche-Posay Toleriane Sensitive Fluide',
                    brand: 'La Roche-Posay',
                    price: '$24.99',
                    budget: 'affordable',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.4,
                    reviews: 12300,
                    description: 'Minimalist formula for sensitive skin',
                    ingredients: ['Thermal Spring Water', 'Glycerin', 'Squalane'],
                    features: ['Minimal Ingredients', 'Fragrance-Free', 'Non-Comedogenic'],
                    skinConcerns: ['Sensitivity', 'Basic Hydration', 'Minimal Irritation'],
                    usage: 'Use morning and evening'
                },
                {
                    id: 'sensitive-premium-1',
                    name: 'Drunk Elephant Lala Retro Whipped Cream',
                    brand: 'Drunk Elephant',
                    price: '$60.00',
                    budget: 'premium',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.5,
                    reviews: 5600,
                    description: 'Whipped moisturizer with African oils',
                    ingredients: ['African Oils', 'Ceramides', 'Hyaluronic Acid'],
                    features: ['Cruelty-Free', 'Fragrance-Free', 'Silicone-Free'],
                    skinConcerns: ['Barrier Repair', 'Intensive Moisture', 'Gentle Care'],
                    usage: 'Use as needed for intensive moisture'
                },
                {
                    id: 'sensitive-premium-2',
                    name: 'Tatcha The Indigo Cream',
                    brand: 'Tatcha',
                    price: '$85.00',
                    budget: 'premium',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.7,
                    reviews: 2100,
                    description: 'Anti-redness cream with indigo extract',
                    ingredients: ['Japanese Indigo', 'Hadasei-3 Complex', 'Colloidal Oatmeal'],
                    features: ['Natural Ingredients', 'Anti-Redness', 'Luxury Formula'],
                    skinConcerns: ['Redness', 'Sensitivity', 'Luxury Care'],
                    usage: 'Use morning and evening'
                }
            ],
            scienceExplanations: [
                { title: "Understanding Skin Reactivity", content: "Sensitive skin has a compromised barrier function and heightened nerve responses. The stratum corneum is thinner, allowing irritants to penetrate more easily and trigger inflammatory responses." },
                { title: "The Importance of pH Balance", content: "Sensitive skin often has an altered pH level. Healthy skin pH is around 4.7-5.5. Using pH-balanced products helps maintain the acid mantle, which protects against pathogens and irritation." }
            ]
        }
    };

    /* =========================================================
       DATA PERSISTENCE HELPERS
    ========================================================== */
    function getUserData() {
        if (!currentUser) return null;
        const raw = localStorage.getItem(`data_${currentUser.email}`);
        return raw ? JSON.parse(raw) : { analyses: [], savedProducts: [], photos: [] };
    }

    function saveUserData(data) {
        if (!currentUser) return;
        localStorage.setItem(`data_${currentUser.email}`, JSON.stringify(data));
    }

    function saveAnalysis() {
        if (!currentUser) return;
        const data = getUserData();
        data.analyses.push({
            date: new Date().toISOString(),
            skinType: currentSkinType,
            concerns: skinAnalysis.concerns,
            confidence: skinAnalysis.confidence
        });
        saveUserData(data);
        
        // Also update user object
        currentUser.analyses = data.analyses;
        localStorage.setItem('skincastUser', JSON.stringify(currentUser));
    }

    function addToRoutine(productId) {
        if (!currentUser) {
            showNotification('Please login to save products', 'warning');
            return;
        }
        const data = getUserData();
        if (data.savedProducts.includes(productId)) {
            showNotification('Product already in your routine', 'info');
            return;
        }
        data.savedProducts.push(productId);
        saveUserData(data);
        
        // Update user object
        currentUser.savedProducts = data.savedProducts;
        localStorage.setItem('skincastUser', JSON.stringify(currentUser));
        
        // Update button
        const btn = event.target;
        btn.innerHTML = '<i class="fas fa-check mr-2"></i>Saved';
        btn.classList.remove('bg-gradient-to-r', 'from-purple-500', 'to-blue-500');
        btn.classList.add('bg-green-500');
        
        showNotification('Product added to your routine!', 'success');
    }

    /* =========================================================
       CAMERA & SCAN ANIMATION
    ========================================================== */
    async function: 'Balancing Moisturizer', type: 'Moisturizer', purpose: 'Hydrate without clogging', application: 'More on dry areas, less on oily areas', timing: 'Daily' }
            ],
            products: [
                {
                    id: 'combo-budget-1',
                    name: 'Cetaphil Daily Facial Cleanser',
                    brand: 'Cetaphil',
                    price: '$11.99',
                    budget: 'affordable',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.4,
                    reviews: 18200,
                    description: 'Gentle cleanser for combination skin',
                    ingredients: ['Glycerin', 'Niacinamide', 'Panthenol'],
                    features: ['Soap-Free', 'Non-Comedogenic', 'Dermatologist Recommended'],
                    skinConcerns: ['Combination Skin', 'Gentle Cleansing', 'pH Balance'],
                    usage: 'Use morning and evening'
                },
                {
                    id: 'combo-budget-2',
                    name: 'The Ordinary Niacinamide 10% + Zinc 1%',
                    brand: 'The Ordinary',
                    price: '$6.80',
                    budget: 'affordable',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.5,
                    reviews: 45800,
                    description: 'Oil control and pore minimizing serum',
                    ingredients: ['Niacinamide 10%', 'Zinc PCA 1%'],
                    features: ['Vegan', 'Oil-Free', 'Fragrance-Free'],
                    skinConcerns: ['Oil Control', 'Pore Minimizing', 'Breakout Prevention'],
                    usage: 'Use after cleansing, focus on T-zone'
                },
                {
                    id: 'combo-premium-1',
                    name: 'Youth to the People Superfood Cleanser',
                    brand: 'Youth to the People',
                    price: '$36.00',
                    budget: 'premium',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.6,
                    reviews: 8900,
                    description: 'Cold-pressed antioxidants rich cleanser',
                    ingredients: ['Kale', 'Spinach', 'Green Tea', 'Vitamins'],
                    features: ['Vegan', 'Cruelty-Free', 'Cold-Pressed'],
                    skinConcerns: ['Combination Skin', 'Antioxidant Protection', 'Gentle Cleansing'],
                    usage: 'Use morning and evening'
                },
                {
                    id: 'combo-premium-2',
                    name: 'Tatcha The Water Cream',
                    brand: 'Tatcha',
                    price: '$68.00',
                    budget: 'premium',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.5,
                    reviews: 3400,
                    description: 'Oil-free anti-aging water cream',
                    ingredients: ['Japanese Wild Rose', 'Hadasei-3 Complex', 'Tatcha\'s Signature'],
                    features: ['Oil-Free', 'Non-Comedogenic', 'Anti-Aging'],
                    skinConcerns: ['Combination Skin', 'Pore Refining', 'Anti-Aging'],
                    usage: 'Use morning and evening'
                }
            ],
            scienceExplanations: [
                { title: "Zone-Based Skincare Science", content: "Combination skin requires different approaches for different facial zones. The T-zone has more sebaceous glands per square inch than other facial areas, requiring oil control, while cheeks need hydration support." },
                { title: "Niacinamide: The Balancing Act", content: "Niacinamide helps regulate sebum production in oily areas while strengthening the skin barrier in dry areas. It's particularly effective for combination skin as it addresses multiple concerns simultaneously." }
            ]
        },
        'Normal Skin': {
            description: 'Products to maintain balance and provide preventive care',
            concerns: ['Maintenance', 'Prevention', 'Environmental Protection', 'Healthy Glow'],
            keyIngredients: ['Vitamin C', 'Peptides', 'Antioxidants', 'Hyaluronic Acid'],
            morningRoutine: [
                { step: 1, product: 'Gentle Cleanser', type: 'Cleanser', purpose: 'Refresh skin and remove overnight impurities', application: 'Gentle circular motions, rinse with lukewarm water', timing: 'Daily' },
                { step: 2, product: 'Vitamin C Serum', type: 'Antioxidant', purpose: 'Protect against environmental damage', application: 'Apply to clean, dry skin', timing: 'Daily' },
                { step: 3, product: 'Light Moisturizer', type: 'Moisturizer', purpose: 'Maintain hydration balance', application: 'Pea-sized amount, massage gently', timing: 'Daily' },
                { step: 4, product: 'Broad Spectrum Sunscreen', type: 'Sun Protection', purpose: 'Prevent premature aging and damage', application: 'Apply 15 minutes before sun exposure', timing: 'Daily' }
            ],
            eveningRoutine: [
                { step: 1, product: 'Cleansing Balm/Gel', type: 'Cleanser', purpose: 'Remove makeup, sunscreen, and daily buildup', application: 'Massage thoroughly, especially on sunscreen areas', timing: 'Daily' },
                { step: 2, product: 'Treatment Serum', type: 'Treatment', purpose: 'Address specific concerns (anti-aging, texture)', application: 'Allow to absorb completely', timing: '3-4 times weekly' },
                { step: 3, product: 'Hydrating Serum', type: 'Hydration', purpose: 'Maintain optimal moisture levels', application: 'Apply while skin is still slightly damp', timing: 'Daily' },
                { step: 4, product: 'Night Moisturizer', type: 'Moisturizer', purpose: 'Support overnight skin repair', application: 'Generous amount, allow to absorb', timing: 'Daily' }
            ],
            products: [
                {
                    id: 'normal-budget-1',
                    name: 'Vanicream Gentle Facial Cleanser',
                    brand: 'Vanicream',
                    price: '$8.99',
                    budget: 'affordable',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.6,
                    reviews: 12300,
                    description: 'Gentle cleanser for sensitive normal skin',
                    ingredients: ['Glycerin', 'Purified Water', 'Cocoyl Glycinate'],
                    features: ['Fragrance-Free', 'Soap-Free', 'Dermatologist Recommended'],
                    skinConcerns: ['Gentle Cleansing', 'Sensitive Skin', 'Daily Use'],
                    usage: 'Use morning and evening'
                },
                {
                    id: 'normal-budget-2',
                    name: 'The Ordinary Vitamin C Suspension 23%',
                    brand: 'The Ordinary',
                    price: '$5.80',
                    budget: 'affordable',
                    image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
                    rating: 4.3,
                    reviews: 28900,
                    description:
                    'Direct vitamin C for brightening',
ingredients: ['Vitamin C 23%', 'Hyaluronic Acid', 'Silicone'],
features: ['Vegan', 'Cruelty-Free', 'Direct Vitamin C'],
skinConcerns: ['Brightening', 'Anti-Aging', 'Antioxidant Protection'],
usage: 'Use in morning, can be mixed with moisturizer'
},
{
id: 'normal-premium-1',
name: 'SkinCeuticals C E Ferulic',
brand: 'SkinCeuticals',
price: '$169.00',
budget: 'premium',
image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
rating: 4.8,
reviews: 4200,
description: 'Advanced antioxidant vitamin C serum',
ingredients: ['Vitamin C 15%', 'Vitamin E', 'Ferulic Acid'],
features: ['Clinical Results', 'Patented Formula', 'Dermatologist Developed'],
skinConcerns: ['Anti-Aging', 'Environmental Protection', 'Brightening'],
usage: 'Use 4-5 drops in morning after cleansing'
},
{
id: 'normal-premium-2',
name: 'Drunk Elephant Protini Polypeptide Cream',
brand: 'Drunk Elephant',
price: '$68.00',
budget: 'premium',
image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
rating: 4.6,
reviews: 7800,
description: 'Protein moisturizer with peptides and amino acids',
ingredients: ['Signal Peptides', 'Growth Factors', 'Amino Acids', 'Pygmy Waterlily'],
features: ['Vegan', 'Cruelty-Free', 'Silicone-Free'],
skinConcerns: ['Firmness', 'Elasticity', 'Protein Support'],
usage: 'Use morning and evening'
}
],
scienceExplanations: [
{ title: "Preventive Skincare Science", content: "Normal skin is the ideal baseline - balanced oil production, adequate hydration, and minimal concerns. The focus should be on prevention rather than treatment, using antioxidants to protect against environmental damage." },
{ title: "Vitamin C: The Master Antioxidant", content: "Vitamin C neutralizes free radicals from UV exposure and pollution, stimulates collagen production, and inhibits melanin synthesis. It's essential for preventing premature aging in normal skin." }
]
},
'Sensitive Skin': {
description: 'Gentle products to calm, soothe, and strengthen sensitive skin',
concerns: ['Redness', 'Irritation', 'Reactivity', 'Barrier Weakness', 'Stinging'],
keyIngredients: ['Centella Asiatica', 'Ceramides', 'Niacinamide', 'Oat Extract', 'Aloe Vera'],
morningRoutine: [
{ step: 1, product: 'Ultra-Gentle Cleanser', type: 'Cleanser', purpose: 'Cleanse without disrupting skin barrier', application: '10-second contact time maximum', timing: 'Daily' },
{ step: 2, product: 'Calming Toner/Essence', type: 'Soother', purpose: 'Reduce redness and prepare skin', application: 'Pat gently with hands, no rubbing', timing: 'Daily' },
{ step: 3, product: 'Barrier Repair Serum', type: 'Treatment', purpose: 'Strengthen skin barrier', application: 'Apply to slightly damp skin', timing: 'Daily' },
{ step: 4, product: 'Gentle Moisturizer', type: 'Moisturizer', purpose: 'Provide protection and hydration', application: 'Gentle pressing motion', timing: 'Daily' },
{ step: 5, product: 'Mineral Sunscreen', type: 'Sun Protection', purpose: 'Physical protection without irritation', application: 'Pat gently, avoid rubbing', timing: 'Daily' }
],
eveningRoutine: [
{ step: 1, product: 'Micellar Water/Cleansing Milk', type: 'Cleanser', purpose: 'Remove makeup and impurities gently', application: 'Soak cotton pad, gentle swipes', timing: 'Daily' },
{ step: 2, product: 'Gentle Cream Cleanser', type: 'Cleanser', purpose: 'Second cleanse without stripping', application: 'Minimal contact time, cool water', timing: 'Daily' },
{ step: 3, product: 'Calming Treatment', type: 'Treatment', purpose: 'Reduce inflammation and redness', application: 'Wait for skin to calm between steps', timing: 'Daily' },
{ step: 4, product: 'Rich Moisturizer', type: 'Moisturizer', purpose: 'Intensive barrier support', application: 'Generous amount, gentle application', timing: 'Daily' },
{ step: 5, product: 'Facial Oil (Optional)', type: 'Occlusive', purpose: 'Extra barrier protection', application: '2-3 drops, press gently', timing: 'As needed' }
],
products: [
{
id: 'sensitive-budget-1',
name: 'Avene Tolerance Control Cleanser',
brand: 'Avene',
price: '$32.00',
budget: 'affordable',
image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
rating: 4.5,
reviews: 8900,
description: 'Ultra-gentle cleanser for reactive skin',
ingredients: ['Thermal Spring Water', 'Dexpanthanol', 'Ceramides'],
features: ['Sterile Formula', 'Fragrance-Free', 'Paraben-Free'],
skinConcerns: ['Sensitivity', 'Redness', 'Barrier Repair'],
usage: 'Use morning and evening, minimal contact time'
},
{
id: 'sensitive-budget-2',
name: 'La Roche-Posay Toleriane Sensitive Fluide',
brand: 'La Roche-Posay',
price: '$24.99',
budget: 'affordable',
image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
rating: 4.4,
reviews: 12300,
description: 'Minimalist formula for sensitive skin',
ingredients: ['Thermal Spring Water', 'Glycerin', 'Squalane'],
features: ['Minimal Ingredients', 'Fragrance-Free', 'Non-Comedogenic'],
skinConcerns: ['Sensitivity', 'Basic Hydration', 'Minimal Irritation'],
usage: 'Use morning and evening'
},
{
id: 'sensitive-premium-1',
name: 'Drunk Elephant Lala Retro Whipped Cream',
brand: 'Drunk Elephant',
price: '$60.00',
budget: 'premium',
image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
rating: 4.5,
reviews: 5600,
description: 'Whipped moisturizer with African oils',
ingredients: ['African Oils', 'Ceramides', 'Hyaluronic Acid'],
features: ['Cruelty-Free', 'Fragrance-Free', 'Silicone-Free'],
skinConcerns: ['Barrier Repair', 'Intensive Moisture', 'Gentle Care'],
usage: 'Use as needed for intensive moisture'
},
{
id: 'sensitive-premium-2',
name: 'Tatcha The Indigo Cream',
brand: 'Tatcha',
price: '$85.00',
budget: 'premium',
image: 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=300&h=300&fit=crop',
rating: 4.7,
reviews: 2100,
description: 'Anti-redness cream with indigo extract',
ingredients: ['Japanese Indigo', 'Hadasei-3 Complex', 'Colloidal Oatmeal'],
features: ['Natural Ingredients', 'Anti-Redness', 'Luxury Formula'],
skinConcerns: ['Redness', 'Sensitivity', 'Luxury Care'],
usage: 'Use morning and evening'
}
],
scienceExplanations: [
{ title: "Understanding Skin Reactivity", content: "Sensitive skin has a compromised barrier function and heightened nerve responses. The stratum corneum is thinner, allowing irritants to penetrate more easily and trigger inflammatory responses." },
{ title: "The Importance of pH Balance", content: "Sensitive skin often has an altered pH level. Healthy skin pH is around 4.7-5.5. Using pH-balanced products helps maintain the acid mantle, which protects against pathogens and irritation." }
]
}
};
    /* =========================================================
       DATA PERSISTENCE HELPERS
    ========================================================== */
    function getUserData() {
        if (!currentUser) return null;
        const raw = localStorage.getItem(`data_${currentUser.email}`);
        return raw ? JSON.parse(raw) : { analyses: [], savedProducts: [], photos: [] };
    }

    function saveUserData(data) {
        if (!currentUser) return;
        localStorage.setItem(`data_${currentUser.email}`, JSON.stringify(data));
    }

    function saveAnalysis() {
        if (!currentUser) return;
        const data = getUserData();
        data.analyses.push({
            date: new Date().toISOString(),
            skinType: currentSkinType,
            concerns: skinAnalysis.concerns,
            confidence: skinAnalysis.confidence
        });
        saveUserData(data);
        
        // Also update user object
        currentUser.analyses = data.analyses;
        localStorage.setItem('skincastUser', JSON.stringify(currentUser));
    }

    function addToRoutine(productId) {
        if (!currentUser) {
            showNotification('Please login to save products', 'warning');
            return;
        }
        const data = getUserData();
        if (data.savedProducts.includes(productId)) {
            showNotification('Product already in your routine', 'info');
            return;
        }
        data.savedProducts.push(productId);
        saveUserData(data);
        
        // Update user object
        currentUser.savedProducts = data.savedProducts;
        localStorage.setItem('skincastUser', JSON.stringify(currentUser));
        
        // Update button
        const btn = event.target;
        btn.innerHTML = '<i class="fas fa-check mr-2"></i>Saved';
        btn.classList.remove('bg-gradient-to-r', 'from-purple-500', 'to-blue-500');
        btn.classList.add('bg-green-500');
        
        showNotification('Product added to your routine!', 'success');
    }

    /* =========================================================
       CAMERA & SCAN ANIMATION
    ========================================================== */
    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { width: 640, height: 480, facingMode: 'user' } 
            });
            
            const video = document.getElementById('webcam-video');
            const placeholder = document.getElementById('camera-placeholder');
            
            video.srcObject = stream;
            currentStream = stream;
            
            video.classList.remove('hidden');
            placeholder.classList.add('hidden');
            
            document.getElementById('startBtn').classList.add('hidden');
            document.getElementById('stopBtn').classList.remove('hidden');
            document.getElementById('realtimeBtn').disabled = false;
            
            isCameraOn = true;
            
            // Show scan animation
            document.getElementById('scan-animation').classList.remove('hidden');
            
        } catch (error) {
            console.error('Error accessing camera:', error);
            showNotification('Camera access denied. Please allow camera access and try again.', 'error');
        }
    }

    function stopCamera() {
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
        }
        
        const video = document.getElementById('webcam-video');
        const placeholder = document.getElementById('camera-placeholder');
        
        video.classList.add('hidden');
        placeholder.classList.remove('hidden');
        
        document.getElementById('startBtn').classList.remove('hidden');
        document.getElementById('stopBtn').classList.add('hidden');
        document.getElementById('realtimeBtn').disabled = true;
        
        isCameraOn = false;
        
        // Hide scan animation
        document.getElementById('scan-animation').classList.add('hidden');
        
        if (predictionInterval) {
            clearInterval(predictionInterval);
            predictionInterval = null;
        }
    }

    function startRealTimePrediction() {
        if (!isCameraOn) {
            showNotification('Please start camera first', 'warning');
            return;
        }
        
        showLoading();
        
        setTimeout(() => {
            hideLoading();
            const skinTypes = ['Acne-Prone Skin', 'Dry Skin', 'Combination Skin', 'Normal Skin', 'Sensitive Skin'];
            const randomSkinType = skinTypes[Math.floor(Math.random() * skinTypes.length)];
            
            updatePredictionDisplay(randomSkinType);
            
        }, 2000);
    }

    function updatePredictionDisplay(skinType) {
        const display = document.getElementById('prediction-display');
        display.innerHTML = `
            <div class="text-center">
                <div class="text-2xl mb-2">🔍</div>
                <h4 class="text-lg font-bold text-white mb-2">Detected: ${skinType}</h4>
                <div class="text-sm text-white/80">Confidence: ${(85 + Math.random() * 10).toFixed(1)}%</div>
            </div>
        `;
    }

    /* =========================================================
       DEMO & RESULTS
    ========================================================== */
    function showDemoResults() {
        showLoading();
        
        setTimeout(() => {
            hideLoading();
            
            const skinTypes = ['Acne-Prone Skin', 'Dry Skin', 'Combination Skin', 'Normal Skin', 'Sensitive Skin'];
            currentSkinType = skinTypes[Math.floor(Math.random() * skinTypes.length)];
            
            skinAnalysis = {
                skinType: currentSkinType,
                concerns: {
                    'Hydration': Math.floor(Math.random() * 40) + 20,
                    'Oil Control': Math.floor(Math.random() * 40) + 20,
                    'Sensitivity': Math.floor(Math.random() * 40) + 20,
                    'Anti-Aging': Math.floor(Math.random() * 40) + 20,
                    'Pore Size': Math.floor(Math.random() * 40) + 20
                },
                confidence: Math.floor(Math.random() * 15) + 85
            };
            
            showResults();
            
        }, 3000);
    }

    function showResults() {
        document.getElementById('results-section').classList.remove('hidden');
        
        // Update skin type result
        const skinTypeResult = document.getElementById('skin-type-result');
        skinTypeResult.innerHTML = `
            <div class="bg-gradient-to-r from-purple-500 to-blue-500 text-white px-8 py-4 rounded-2xl inline-block">
                <h4 class="text-2xl font-bold mb-2">Your Skin Type: ${currentSkinType}</h4>
                <p class="text-white/90">${productDatabase[currentSkinType].description}</p>
            </div>
        `;
        
        // Create concerns chart
        createConcernsChart();
        
        // Load products
        loadProducts();
        
        // Load routines
        loadRoutines();
        
        // Load science content
        loadScienceContent();
        
        // Scroll to results
        document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });
        
        // Save analysis if user is logged in
        if (currentUser) {
            saveAnalysis();
        }
    }

    function createConcernsChart() {
        const data = [{
            x: Object.keys(skinAnalysis.concerns),
            y: Object.values(skinAnalysis.concerns),
            type: 'bar',
            marker: {
                color: ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe'],
                opacity: 0.8
            }
        }];
        
        const layout = {
            title: 'Skin Concerns Analysis',
            xaxis: { title: 'Concern Areas' },
            yaxis: { title: 'Priority Level (%)', range: [0, 100] },
            margin: { t: 50, b: 80, l: 60, r: 40 },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: '#374151' }
        };
        
        Plotly.newPlot('concerns-chart', data, layout, {responsive: true});
    }

    function loadProducts() {
        const productGrid = document.getElementById('product-grid');
        const products = productDatabase[currentSkinType].products;
        
        productGrid.innerHTML = products.map(product => `
            <div class="product-card glass-morphism rounded-2xl p-6 relative" data-budget="${product.budget}">
                <div class="budget-badge ${product.budget === 'affordable' ? 'budget-affordable' : 'budget-premium'}">
                    ${product.budget === 'affordable' ? 'Budget-Friendly' : 'Premium'}
                </div>
                
                <div class="aspect-square mb-4 rounded-xl overflow-hidden">
                    <img src="${product.image}" alt="${product.name}" class="w-full h-full object-cover">
                </div>
                
                <div class="mb-4">
                    <h5 class="text-lg font-bold text-white mb-1">${product.name}</h5>
                    <p class="text-white/70 text-sm mb-2">${product.brand}</p>
                    <p class="text-white/80 text-sm mb-3">${product.description}</p>
                </div>
                
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-2xl font-bold text-white">${product.price}</span>
                        <div class="flex items-center">
                            <div class="flex text-yellow-400 mr-2">
                                ${'★'.repeat(Math.floor(product.rating))}${'☆'.repeat(5 - Math.floor(product.rating))}
                            </div>
                            <span class="text-white/70 text-sm">${product.rating}</span>
                        </div>
                    </div>
                    <p class="text-white/60 text-xs">${product.reviews.toLocaleString()} reviews</p>
                </div>
                
                <div class="mb-4">
                    <h6 class="text-white font-semibold mb-2">Key Ingredients:</h6>
                    <div class="flex flex-wrap gap-2">
                        ${product.ingredients.slice(0, 3).map(ingredient => 
                            `<span class="ingredient-tag px-3 py-1 rounded-full text-xs font-medium">${ingredient}</span>`
                        ).join('')}
                    </div>
                </div>
                
                <div class="mb-4">
                    <h6 class="text-white font-semibold mb-2">Usage:</h6>
                    <p class="text-white/80 text-sm">${product.usage}</p>
                </div>
                
                <div class="flex flex-wrap gap-2 mb-4">
                    ${product.features.map(feature => 
                        `<span class="bg-white/10 text-white px-2 py-1 rounded-lg text-xs">${feature}</span>`
                    ).join('')}
                </div>
                
                <button onclick="addToRoutine('${product.id}')" class="w-full bg-gradient-to-r from-purple-500 to-blue-500 text-white py-3 rounded-xl font-semibold hover:from-purple-600 hover:to-blue-600 transition-all">
                    <i class="fas fa-plus mr-2"></i>Add to Routine
                </button>
            </div>
        `).join('');
    }

    function loadRoutines() {
        const morningRoutine = document.getElementById('morning-routine');
        const eveningRoutine = document.getElementById('evening-routine');
        
        const morningSteps = productDatabase[currentSkinType].morningRoutine;
        const eveningSteps = productDatabase[currentSkinType].eveningRoutine;
        
        morningRoutine.innerHTML = morningSteps.map((step, index) => `
            <div class="routine-step bg-white/10 p-4 rounded-xl mb-4">
                <div class="flex items-start space-x-4">
                    <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm">
                        ${step.step}
                    </div>
                    <div class="flex-1">
                        <h5 class="text-white font-semibold mb-1">${step.product}</h5>
                        <p class="text-white/80 text-sm mb-2">${step.purpose}</p>
                        <p class="text-white/60 text-xs mb-2">${step.application}</p>
                        <span class="bg-white/20 text-white px-2 py-1 rounded-lg text-xs">${step.timing}</span>
                    </div>
                </div>
            </div>
        `).join('');
        
        eveningRoutine.innerHTML = eveningSteps.map((step, index) => `
            <div class="routine-step bg-white/10 p-4 rounded-xl mb-4">
                <div class="flex items-start space-x-4">
                    <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm">
                        ${step.step}
                    </div>
                    <div class="flex-1">
                        <h5 class="text-white font-semibold mb-1">${step.product}</h5>
                        <p class="text-white/80 text-sm mb-2">${step.purpose}</p>
                        <p class="text-white/60 text-xs mb-2">${step.application}</p>
                        <span class="bg-white/20 text-white px-2 py-1 rounded-lg text-xs">${step.timing}</span>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function loadScienceContent() {
        const scienceContent = document.getElementById('science-content');
        const explanations = productDatabase[currentSkinType].scienceExplanations;
        
        scienceContent.innerHTML = explanations.map((explanation, index) => `
            <div class="bg-white/10 p-6 rounded-xl mb-4">
                <h5 class="text-white font-bold text-lg mb-3">
                    <i class="fas fa-flask mr-2 text-purple-400"></i>${explanation.title}
                </h5>
                <p class="text-white/80 leading-relaxed">${explanation.content}</p>
            </div>
        `).join('');
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });
        
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('active');
        });
        
        document.getElementById(`${tabName}-tab`).classList.remove('hidden');
        document.getElementById(`tab-${tabName}`).classList.add('active');
    }

    function filterProducts(budget) {
        const products = document.querySelectorAll('.product-card');
        const buttons = document.querySelectorAll('.filter-btn');
        
        buttons.forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        products.forEach(product => {
            if (budget === 'all') {
                product.style.display = 'block';
            } else {
                const productBudget = product.dataset.budget;
                if (productBudget === budget) {
                    product.style.display = 'block';
                } else {
                    product.style.display = 'none';
                }
            }
        });
    }

    function addToRoutine(productId) {
        if (!currentUser) {
            showNotification('Please login to save products', 'warning');
            return;
        }
        const data = getUserData();
        if (data.savedProducts.includes(productId)) {
            showNotification('Product already in your routine', 'info');
            return;
        }
        data.savedProducts.push(productId);
        saveUserData(data);
        
        // Update user object
        currentUser.savedProducts = data.savedProducts;
        localStorage.setItem('skincastUser', JSON.stringify(currentUser));
        
        // Update button
        const btn = event.target;
        btn.innerHTML = '<i class="fas fa-check mr-2"></i>Saved';
        btn.classList.remove('bg-gradient-to-r', 'from-purple-500', 'to-blue-500');
        btn.classList.add('bg-green-500');
        
        showNotification('Product added to your routine!', 'success');
    }

    function startNewAnalysis() {
        document.getElementById('results-section').classList.add('hidden');
        stopCamera();
        
        document.getElementById('prediction-display').innerHTML = `
            <p class="text-white/80 text-center">Start camera to see real-time analysis</p>
        `;
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function shareResults() {
        if (navigator.share) {
            navigator.share({
                title: 'My SkinCast AI Analysis Results',
                text: `I just got my personalized skincare analysis from SkinCast AI! My skin type is ${currentSkinType}.`,
                url: window.location.href
            });
        } else {
            const text = `I just got my personalized skincare analysis from SkinCast AI! My skin type is ${currentSkinType}. Check it out: ${window.location.href}`;
            navigator.clipboard.writeText(text).then(() => {
                showNotification('Results copied to clipboard!', 'success');
            });
        }
    }

    function showLoading() {
        document.getElementById('loading-overlay').classList.remove('hidden');
        document.getElementById('loading-overlay').classList.add('flex');
    }

    function hideLoading() {
        document.getElementById('loading-overlay').classList.add('hidden');
        document.getElementById('loading-overlay').classList.remove('flex');
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 p-4 rounded-xl text-white max-w-sm ${
            type === 'success' ? 'bg-green-500' : 
            type === 'error' ? 'bg-red-500' : 
            type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'
        }`;
        
        notification.innerHTML = `
            <div class="flex items-center">
                <i class="fas ${
                    type === 'success' ? 'fa-check-circle' : 
                    type === 'error' ? 'fa-exclamation-circle' : 
                    type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'
                } mr-3"></i>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    function createProgressChart() {
        if (!currentUser) {
            document.getElementById('progress-chart').innerHTML = '<p class="text-white/60">Login to view your progress</p>';
            return;
        }
        
        const data = getUserData();
        const dates = data.analyses.map(a => new Date(a.date).toLocaleDateString());
        const scores = data.analyses.map(a => a.confidence);

        if (dates.length === 0) {
            document.getElementById('progress-chart').innerHTML = '<p class="text-white/60">No analyses yet – perform one to see progress</p>';
            return;
        }

        const trace = {
            x: dates,
            y: scores,
            type: 'scatter',
            mode: 'lines+markers',
            line: { color: '#667eea', width: 3 },
            marker: { color: '#667eea', size: 8 }
        };
        const layout = {
            title: 'Skin Health Progress',
            xaxis: { title: 'Date' },
            yaxis: { title: 'Confidence Score', range: [0, 100] },
            margin: { t: 50, b: 50, l: 60, r: 40 },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: 'white' }
        };
        Plotly.newPlot('progress-chart', [trace], layout, { responsive: true });
    }

    document.addEventListener('click', e => {
        if (e.target.id === 'tab-progress') {
            setTimeout(createProgressChart, 100);
        }
    });

    // Initialize on load
    window.addEventListener('DOMContentLoaded', () => {
        initAuth();
    });
</script>
</body>
</html>
